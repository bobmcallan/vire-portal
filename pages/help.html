<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head.html" .}}
    <title>VIRE HELP</title>
</head>
<body>
    {{if .LoggedIn}}{{template "nav.html" .}}{{end}}
    <main class="page" x-data="helpPage()" x-init="init()">
        <div class="page-body">

            <div class="help-header">
                <div class="help-contact">
                    <span class="help-contact-label">CONTACT</span>
                    <a href="mailto:bobmcallan@gmail.com">bobmcallan@gmail.com</a>
                </div>
                <a href="/docs" class="btn btn-secondary btn-sm">DOCUMENTATION</a>
            </div>

            <div class="help-search-wrap">
                <input type="text"
                       class="form-input help-search"
                       placeholder="Search glossary..."
                       x-model="query"
                       @input="filter()">
            </div>

            <template x-if="loading">
                <div class="help-loading">Loading glossary...</div>
            </template>

            <template x-if="error && !loading">
                <div class="warning-banner" x-text="error"></div>
            </template>

            <template x-if="!loading && !error">
                <div>
                    <template x-for="cat in filtered" :key="cat.name">
                        <section class="panel-headed help-category">
                            <div class="panel-header" x-text="cat.name"></div>
                            <div class="panel-content">
                                <template x-for="t in cat.terms" :key="t.term">
                                    <div class="help-term">
                                        <div class="help-term-header">
                                            <span class="help-term-label" x-text="t.label"></span>
                                            <span class="help-term-id" x-text="t.term"></span>
                                        </div>
                                        <p class="help-term-def" x-text="t.definition"></p>
                                        <template x-if="t.formula">
                                            <p class="help-term-formula"><span class="help-term-formula-label">Formula:</span> <span x-text="t.formula"></span></p>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="cat.terms.length === 0">
                                    <p class="text-muted text-sm">No matching terms.</p>
                                </template>
                            </div>
                        </section>
                    </template>
                    <template x-if="filtered.length === 0 && query.length > 0">
                        <p class="text-muted">No results for "<span x-text="query"></span>"</p>
                    </template>
                </div>
            </template>

        </div>
    </main>
    {{template "footer.html" .}}

    <script>
    function helpPage() {
        return {
            categories: [],
            filtered: [],
            query: '',
            loading: true,
            error: null,

            init() {
                fetch('/api/glossary')
                    .then(r => {
                        if (!r.ok) throw new Error('Glossary unavailable (server returned ' + r.status + ')');
                        return r.json();
                    })
                    .then(data => {
                        this.categories = (data.categories || []).map(c => ({
                            name: c.name,
                            terms: (c.terms || []).map(t => ({
                                term: t.term,
                                label: t.label,
                                definition: t.definition,
                                formula: t.formula || null,
                            }))
                        }));
                        this.filtered = this.categories;
                        this.loading = false;
                    })
                    .catch(err => {
                        this.error = err.message;
                        this.loading = false;
                    });
            },

            filter() {
                const q = this.query.toLowerCase().trim();
                if (!q) {
                    this.filtered = this.categories;
                    return;
                }
                this.filtered = this.categories
                    .map(c => ({
                        name: c.name,
                        terms: c.terms.filter(t =>
                            t.label.toLowerCase().includes(q) ||
                            t.term.toLowerCase().includes(q) ||
                            t.definition.toLowerCase().includes(q) ||
                            (t.formula && t.formula.toLowerCase().includes(q))
                        )
                    }))
                    .filter(c => c.terms.length > 0);
            }
        };
    }
    </script>
</body>
</html>
